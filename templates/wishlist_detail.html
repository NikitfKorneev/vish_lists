{% extends "base.html" %}

{% block title %}{{ wishlist.title }}{% endblock %}

{% block content %}
<!-- Заголовок + шаринг -->
<div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:1rem; margin-bottom:1.5rem;">
    <h2 style="margin:0;">{{ wishlist.title }}</h2>
    {% if is_owner %}
    <form action="/wishlist/{{ wishlist.id }}/toggle-share" method="POST">
        <button class="share-btn {% if wishlist.is_shared %}shared{% endif %}">
            {% if wishlist.is_shared %}Отключить публичный доступ{% else %}Сделать публичным{% endif %}
        </button>
    </form>
    {% endif %}
</div>

    {% if wishlist.is_shared %}
    <div class="public-notice">
        Список публичный — ссылка: 
            <code>{{ request.url_root }}wishlist/{{ wishlist.id }}</code>
    </div>
    {% endif %}

    {% if wishlist.description %}
    <p class="description">{{ wishlist.description }}</p>
    {% endif %}

        <!-- Предложение от гостей -->
    {% if not is_owner %}
    <div class="suggest-card">
        <h3>Хотите предложить желание?</h3>
        <a href="/wishlist/{{ wishlist.id }}/suggest" class="suggest-btn">
            Предложить предмет
        </a>
    </div>
    {% endif %}

{% if is_owner %}
<div class="card" style="margin-bottom:3rem;">
    <h3>Добавить желание</h3>
    <form method="POST" action="/wishlist/{{ wishlist.id }}/add-item" style="display:flex; flex-direction:column; gap:0.8rem;">
        <input type="text" name="title" placeholder="Что хотите?" required style="padding:0.6rem; border:1px solid #d1d5db; border-radius:6px;">
        <input type="url" name="url" placeholder="Ссылка" style="padding:0.6rem; border:1px solid #d1d5db; border-radius:6px;">
        <input type="number" name="price" placeholder="Цена" step="0.01" style="padding:0.6rem; border:1px solid #d1d5db; border-radius:6px;">
        <input type="text" name="currency" value="€" style="padding:0.6rem; border:1px solid #d1d5db; border-radius:6px;">
        <textarea name="description" placeholder="Описание" rows="3" style="padding:0.6rem; border:1px solid #d1d5db; border-radius:6px;"></textarea>
        <select name="priority" style="padding:0.6rem; border:1px solid #d1d5db; border-radius:6px;">
            <option value="5">★★★★★</option>
            <option value="4">★★★★</option>
            <option value="3" selected>★★★</option>
            <option value="2">★★</option>
            <option value="1">★</option>
        </select>
        <button type="submit" style="padding:0.7rem; background:#3b82f6; color:white; border:none; border-radius:6px; cursor:pointer;">
            Добавить
        </button>
    </form>
</div>

        <!-- Кнопки владельца -->
        <div class="owner-actions">
            <a href="/wishlist/{{ wishlist.id }}/suggestions" class="action-btn suggestions-btn">
                Посмотреть предложения
            </a>
            <a href="/share-via-telegram" class="action-btn telegram-btn">
                Поделиться через Telegram
            </a>
        </div>
        {% endif %}

        <!-- Список желаний -->
        <h3 class="section-title">Желания в списке</h3>

        {% if items %}
        <div class="grid">
            {% for item in items %}
            <div class="card {% if item.suggested_by %}suggested-item{% endif %}">
                <h3>{{ item.title }}</h3>

                {% if item.url %}
                <a href="{{ item.url }}" target="_blank" class="item-link">Ссылка на товар</a>
                {% endif %}

                {% if item.price %}
                <p class="price">{{ item.price }} {{ item.currency }}</p>
                {% endif %}

                {% if item.description %}
                <p class="description">{{ item.description }}</p>
                {% endif %}

                <div class="meta">
                    Приоритет: {{ "★" * item.priority }}
                </div>

                {% if item.suggested_by %}
                <div class="suggested-badge">
                    Предложено пользователем
                </div>
                {% endif %}

                <!-- Бронирование -->
                {% if item.reserved_by %}
                <div class="reserved-notice">
                    Забронировано {% if item.reserved_by == current_user_id %}вами{% else %}кем-то{% endif %}
                </div>

                {% if item.reserved_by == current_user_id or is_owner %}
                <form action="/wishlist/{{ wishlist.id }}/item/{{ item.id }}/unreserve" method="POST">
                    <button type="submit" class="unreserve-btn">Отменить бронь</button>
                </form>
                {% endif %}
                {% else %}
                {% if not is_owner %}
                <form action="/wishlist/{{ wishlist.id }}/item/{{ item.id }}/reserve" method="POST">
                    <button type="submit" class="reserve-btn">Забронировать</button>
                </form>
                {% endif %}
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-list">
            В этом списке пока нет желаний
            {% if is_owner %} — добавьте первое выше ↑{% endif %}
        </div>
        {% endif %}
    </main>
</body>
</html>